<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotify 3D Ïï®Î≤î Ï∫êÎü¨ÏÖÄ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        transition: background 0.5s ease;
        perspective: 1000px;
      }

      .container {
        max-width: 1200px;
        width: 100%;
      }

      .search-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        margin-bottom: 40px;
      }

      h1 {
        text-align: center;
        color: #1db954;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
      }

      .search-box {
        display: flex;
        gap: 10px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }

      .search-input {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #ddd;
        border-radius: 50px;
        font-size: 16px;
        transition: all 0.3s;
      }

      .search-input:focus {
        outline: none;
        border-color: #1db954;
        box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
      }

      .search-btn {
        padding: 15px 40px;
        background: #1db954;
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .search-btn:hover {
        background: #1ed760;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(29, 185, 84, 0.3);
      }

      .search-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .loading {
        text-align: center;
        color: #666;
        font-size: 18px;
        display: none;
      }

      .carousel-container {
        position: relative;
        height: 600px;
        display: none;
        perspective: 1500px;
      }

      .carousel-3d {
        position: relative;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .carousel-item-3d {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 300px;
        height: 400px;
        margin-left: -150px;
        margin-top: -200px;
        transform-style: preserve-3d;
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
      }

      .album-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        transition: all 0.3s;
      }

      .carousel-item-3d.active .album-wrapper {
        transform: scale(1.1);
      }

      .carousel-item-3d:not(.active) {
        opacity: 0.6;
        filter: blur(2px);
      }

      .album-canvas {
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s;
      }

      .carousel-item-3d.active .album-canvas:hover {
        transform: scale(1.05);
      }

      .album-info {
        margin-top: 20px;
        text-align: center;
        width: 100%;
      }

      .album-name {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .artist-name {
        font-size: 14px;
        color: #666;
      }

      .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 60px;
        height: 60px;
        background: rgba(29, 185, 84, 0.9);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 28px;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 10;
      }

      .carousel-btn:hover {
        background: #1db954;
        transform: translateY(-50%) scale(1.1);
      }

      .prev-btn {
        left: 20px;
      }

      .next-btn {
        right: 20px;
      }

      .indicators {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 30px;
      }

      .indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ddd;
        cursor: pointer;
        transition: all 0.3s;
      }

      .indicator.active {
        background: #1db954;
        width: 30px;
        border-radius: 6px;
      }

      .error-message {
        text-align: center;
        color: #ff4444;
        margin-top: 20px;
        display: none;
      }

      @media (max-width: 768px) {
        .search-section {
          padding: 20px;
        }

        h1 {
          font-size: 2em;
        }

        .search-box {
          flex-direction: column;
        }

        .carousel-container {
          height: 500px;
        }

        .carousel-item-3d {
          width: 250px;
          height: 350px;
          margin-left: -125px;
          margin-top: -175px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="search-section">
        <h1>üéµ Ïï®Î≤î Ïª§Î≤Ñ ÌÉêÏÉâÍ∏∞</h1>
        <p class="subtitle">Ï¢ãÏïÑÌïòÎäî Í∞ÄÏàòÏùò Ïï®Î≤îÏùÑ 3DÎ°ú Í∞êÏÉÅÌï¥Î≥¥ÏÑ∏Ïöî</p>

        <div class="search-box">
          <input
            type="text"
            class="search-input"
            id="artistInput"
            placeholder="Í∞ÄÏàò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: BTS, Ìä∏ÏôÄÏù¥Ïä§, NewJeans)"
          />
          <button class="search-btn" id="searchBtn">Í≤ÄÏÉâ</button>
        </div>

        <div class="loading" id="loading">üîç Ïï®Î≤îÏùÑ Ï∞æÎäî Ï§ë...</div>
        <div class="error-message" id="errorMessage"></div>
      </div>

      <div class="carousel-container" id="carouselContainer">
        <button class="carousel-btn prev-btn" id="prevBtn">‚Äπ</button>
        <div class="carousel-3d" id="carousel3d"></div>
        <button class="carousel-btn next-btn" id="nextBtn">‚Ä∫</button>
        <div class="indicators" id="indicators"></div>
      </div>
    </div>

    <script>
      const CLIENT_ID = "79063631821947c5935c3c93811e4b0d";
      const CLIENT_SECRET = "887ebf0e0c934e72ae5f097cab03e2c6";
      const REDIRECT_URI = "http://192.168.35.13:5500/musicapp_canvas.html";

      let accessToken = "";
      let albums = [];
      let currentIndex = 0;

      const artistInput = document.getElementById("artistInput");
      const searchBtn = document.getElementById("searchBtn");
      const loading = document.getElementById("loading");
      const errorMessage = document.getElementById("errorMessage");
      const carouselContainer = document.getElementById("carouselContainer");
      const carousel3d = document.getElementById("carousel3d");
      const indicators = document.getElementById("indicators");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      // Spotify Access Token Í∞ÄÏ†∏Ïò§Í∏∞
      async function getAccessToken() {
        const response = await fetch("https://accounts.spotify.com/api/token", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Authorization: "Basic " + btoa(CLIENT_ID + ":" + CLIENT_SECRET),
          },
          body: "grant_type=client_credentials",
        });

        const data = await response.json();
        return data.access_token;
      }

      // Í∞ÄÏàò Í≤ÄÏÉâ
      async function searchArtist(artistName) {
        const response = await fetch(
          `https://api.spotify.com/v1/search?q=${encodeURIComponent(
            artistName
          )}&type=artist&limit=1`,
          {
            headers: {
              Authorization: "Bearer " + accessToken,
            },
          }
        );

        const data = await response.json();
        return data.artists.items[0];
      }

      // Ïï®Î≤î Í∞ÄÏ†∏Ïò§Í∏∞
      //   async function getArtistAlbums(artistId) {
      //     const response = await fetch(
      //       `https://api.spotify.com/v1/artists/${artistId}/albums?limit=5&include_groups=album`,
      //       {
      //         headers: {
      //           Authorization: "Bearer " + accessToken,
      //         },
      //       }
      //     );

      //     const data = await response.json();
      //     return data.items;
      //   }

      // Ïï®Î≤î Í∞ÄÏ†∏Ïò§Í∏∞
      async function getArtistAlbums(artistId) {
        const response = await fetch(
          `https://api.spotify.com/v1/artists/${artistId}/albums?limit=10&include_groups=album,single,compilation`,
          {
            headers: {
              Authorization: "Bearer " + accessToken,
            },
          }
        );

        const data = await response.json();
        return data.items;
      }

      // Ïù¥ÎØ∏ÏßÄÏóêÏÑú Ï£ºÏöî ÏÉâÏÉÅ Ï∂îÏ∂ú
      function extractDominantColor(imageUrl, callback) {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.crossOrigin = "Anonymous";

        img.onload = function () {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          let r = 0,
            g = 0,
            b = 0,
            count = 0;

          for (let i = 0; i < data.length; i += 4 * 100) {
            r += data[i];
            g += data[i + 1];
            b += data[i + 2];
            count++;
          }

          r = Math.floor(r / count);
          g = Math.floor(g / count);
          b = Math.floor(b / count);

          r = Math.floor(r * 0.6);
          g = Math.floor(g * 0.6);
          b = Math.floor(b * 0.6);

          callback(`rgb(${r}, ${g}, ${b})`);
        };

        img.src = imageUrl;
      }

      // 3D Ï∫êÎü¨ÏÖÄ ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
      function createCarouselItem3D(album, index) {
        const item = document.createElement("div");
        item.className = "carousel-item-3d";
        item.dataset.index = index;

        const wrapper = document.createElement("div");
        wrapper.className = "album-wrapper";

        const canvas = document.createElement("canvas");
        canvas.className = "album-canvas";
        canvas.width = 250;
        canvas.height = 250;

        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.crossOrigin = "Anonymous";

        img.onload = function () {
          ctx.drawImage(img, 0, 0, 250, 250);
        };

        img.src = album.images[0].url;

        // ÎßàÏö∞Ïä§ Ìò∏Î≤Ñ Ïãú Î∞∞Í≤ΩÏÉâ Î≥ÄÍ≤Ω (ÏÉâÏÉÅ Ïú†ÏßÄ)
        wrapper.addEventListener("mouseenter", function () {
          if (item.classList.contains("active")) {
            extractDominantColor(album.images[0].url, function (color) {
              document.body.style.background = `linear-gradient(135deg, ${color} 0%, ${color} 100%)`;
            });
          }
        });

        // ÌÅ¥Î¶≠ Ïãú Ìï¥Îãπ Ïï®Î≤îÏúºÎ°ú Ïù¥Îèô
        item.addEventListener("click", function () {
          if (!item.classList.contains("active")) {
            currentIndex = index;
            updateCarousel3D();
          }
        });

        const info = document.createElement("div");
        info.className = "album-info";
        info.innerHTML = `
                <div class="album-name">${album.name}</div>
                <div class="artist-name">${album.artists[0].name}</div>
            `;

        wrapper.appendChild(canvas);
        wrapper.appendChild(info);
        item.appendChild(wrapper);

        return item;
      }

      // 3D Ï∫êÎü¨ÏÖÄ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
      function updateCarousel3D() {
        const totalItems = albums.length;
        const angleStep = 360 / totalItems;
        const radius = 400;

        document.querySelectorAll(".carousel-item-3d").forEach((item, index) => {
          const offset = index - currentIndex;
          const angle = offset * angleStep;
          const rad = (angle * Math.PI) / 180;

          const x = Math.sin(rad) * radius;
          const z = Math.cos(rad) * radius - radius;

          let scale = 1;
          let opacity = 0.6;

          if (offset === 0) {
            item.classList.add("active");
            scale = 1;
            opacity = 1;
          } else {
            item.classList.remove("active");
            scale = 0.8;
            opacity = 0.6;
          }

          item.style.transform = `translateX(${x}px) translateZ(${z}px) rotateY(${-angle}deg) scale(${scale})`;
          item.style.opacity = opacity;
          item.style.zIndex = Math.round(100 - Math.abs(z));
        });

        // Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        document.querySelectorAll(".indicator").forEach((indicator, index) => {
          indicator.classList.toggle("active", index === currentIndex);
        });
      }

      // Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÏÉùÏÑ±
      function createIndicators() {
        indicators.innerHTML = "";
        albums.forEach((_, index) => {
          const indicator = document.createElement("div");
          indicator.className = "indicator";
          if (index === 0) indicator.classList.add("active");
          indicator.addEventListener("click", () => {
            currentIndex = index;
            updateCarousel3D();
          });
          indicators.appendChild(indicator);
        });
      }

      // Ïù¥Ï†Ñ Î≤ÑÌäº
      prevBtn.addEventListener("click", () => {
        currentIndex = (currentIndex - 1 + albums.length) % albums.length;
        updateCarousel3D();
      });

      // Îã§Ïùå Î≤ÑÌäº
      nextBtn.addEventListener("click", () => {
        currentIndex = (currentIndex + 1) % albums.length;
        updateCarousel3D();
      });

      // ÌÇ§Î≥¥Îìú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
      document.addEventListener("keydown", e => {
        if (carouselContainer.style.display === "block") {
          if (e.key === "ArrowLeft") {
            prevBtn.click();
          } else if (e.key === "ArrowRight") {
            nextBtn.click();
          }
        }
      });

      // Í≤ÄÏÉâ Ïã§Ìñâ
      async function performSearch() {
        const artistName = artistInput.value.trim();
        if (!artistName) {
          errorMessage.textContent = "Í∞ÄÏàò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.";
          errorMessage.style.display = "block";
          return;
        }

        searchBtn.disabled = true;
        loading.style.display = "block";
        errorMessage.style.display = "none";
        carouselContainer.style.display = "none";

        try {
          if (!accessToken) {
            accessToken = await getAccessToken();
          }

          const artist = await searchArtist(artistName);
          if (!artist) {
            throw new Error("Í∞ÄÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
          }

          albums = await getArtistAlbums(artist.id);
          if (albums.length === 0) {
            throw new Error("Ïï®Î≤îÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
          }

          // 3D Ï∫êÎü¨ÏÖÄ ÏÉùÏÑ±
          carousel3d.innerHTML = "";
          currentIndex = 0;

          albums.forEach((album, index) => {
            carousel3d.appendChild(createCarouselItem3D(album, index));
          });

          createIndicators();
          carouselContainer.style.display = "block";

          // Ï¥àÍ∏∞ ÏúÑÏπò ÏÑ§Ï†ï
          setTimeout(() => updateCarousel3D(), 100);
        } catch (error) {
          errorMessage.textContent = error.message || "Ïï®Î≤îÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.";
          errorMessage.style.display = "block";
          console.error("Error:", error);
        } finally {
          loading.style.display = "none";
          searchBtn.disabled = false;
        }
      }

      // Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠
      searchBtn.addEventListener("click", performSearch);

      // ÏóîÌÑ∞ÌÇ§Î°ú Í≤ÄÏÉâ
      artistInput.addEventListener("keypress", e => {
        if (e.key === "Enter") {
          performSearch();
        }
      });

      // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÌÜ†ÌÅ∞ ÎØ∏Î¶¨ Í∞ÄÏ†∏Ïò§Í∏∞
      getAccessToken().then(token => {
        accessToken = token;
      });
    </script>
  </body>
</html>
